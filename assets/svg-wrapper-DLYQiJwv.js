import{ad as Ot,j as m}from"./chakra-CSR0Uih-.js";import{w as Wt,ap as Ct,a0 as jt,e as Z,L as G,o as Y,aq as Ft,ar as qt,as as Ut,at as Mt,c as Ht,p as Xt,au as tt,av as ft,T as lt,aw as _t,ax as Et,t as dt,v as ut,ay as nt,n as ht,m as Gt,l as $t,r as xt,E as mt,q as vt,z as St,az as Zt,S as Qt,aA as Jt,B as pt,am as te,an as ee,a2 as ne,A as Nt,d as se,_ as oe}from"./index-TYtKMSB_.js";import{b as Lt,r as X,s as yt,g as Kt,f as Yt,e as ie,h as et,j as re,k as ae,l as ce,n as le,p as J,o as de,q as ue,i as st,t as he}from"./master-manager-BNVmxtPz.js";import{k as Rt,b as D}from"./react-eFT_xHYJ.js";import{u as q,e as fe,i as ye}from"./clipboard-D7_gDw5t.js";import{r as ge}from"./server-DoDabHRA.js";import{m as gt}from"./misc-nodes-yC-28M5k.js";const pe={[jt.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[jt.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},xe=t=>{const e=pe[t];return e.at(Math.floor(Math.random()*e.length))},Dt=Rt("runtime/getStationNames",async({cityName:t},{getState:e,dispatch:d,rejectWithValue:h})=>{const{token:r}=e().account;if(!r){d(Ct({cityName:t,names:[]}));return}const a=await fetch("".concat(ge,"/").concat(t),{headers:{accept:"application/json","Content-Type":"application/json",Authorization:"Bearer ".concat(r)}});if(!a.ok)return Wt.warn("Failed to fetch random station names",a.statusText),h(a.statusText);const A=await a.json();d(Ct({cityName:t,names:A}))}),Tt=Rt("runtime/getOneStationName",async(t,{getState:e,dispatch:d})=>{var g;const{stationNames:h}=e().runtime,r=h[t];if(((g=r==null?void 0:r.length)!=null?g:0)==0)return Wt.debug("No random station names in cache, using fallback"),d(Dt({cityName:t})),Object.values(xe(t));const a=structuredClone(r),A=a.shift();return d(Ct({cityName:t,names:a})),a.length<3&&d(Dt({cityName:t})),Object.values(A)}),me=D.memo(t=>{const{svgViewBoxMin:e,svgViewBoxZoom:d,svgWidth:h,svgHeight:r}=t,{preference:{toolsPanel:{expand:a}}}=Z(j=>j.app),g=Ot().colorMode==="light"?"#666464":"#D3D3D4",c=Lt(e,d,h,r),s=a?410*d/100:0,o=d>30?d>120?50:25:5,x=d/200,i={startX:X(c.xMin+s-o,o),endX:X(c.xMax+s+o,o),startY:X(c.yMin-o,o),endY:X(c.yMax+o,o)},u=Array.from({length:(i.endX-i.startX)/o+1},(j,f)=>{const y=i.startX+f*o,l=y%(o*5)===0?2*x:x;return m.jsx("line",{x1:y,y1:i.startY,x2:y,y2:i.endY,strokeWidth:l,stroke:g,opacity:"0.5"},"grid_vl_".concat(y))}),v=Array.from({length:(i.endY-i.startY)/o+1},(j,f)=>{const y=i.startY+f*o,l=y%(o*5)===0?2*x:x;return m.jsx("line",{x1:i.startX,y1:y,x2:i.endX,y2:y,strokeWidth:l,stroke:g,opacity:"0.5"},"grid_hl_".concat(y))}),L=Array.from({length:(i.endX-i.startX)/o/5+1},(j,f)=>{const y=X(i.startX,5*o)+f*5*o;return m.jsx("text",{x:y,y:c.yMin+d/5,fontSize:x*25,fill:g,textAnchor:"middle",opacity:"0.5",children:y},"grid_vc_".concat(y))}),M=Array.from({length:(i.endY-i.startY)/o/5+1},(j,f)=>{const y=X(i.startY,5*o)+f*5*o;return m.jsx("text",{x:c.xMin+d/8+s,y,fontSize:x*25,fill:g,textAnchor:"start",opacity:"0.5",children:y},"grid_hc_".concat(y))});return m.jsxs("g",{id:"grid-lines",className:"removeMe",children:[u,v,L,M]})},(t,e)=>t.svgViewBoxMin.x===e.svgViewBoxMin.x&&t.svgViewBoxMin.y===e.svgViewBoxMin.y&&t.svgViewBoxZoom===e.svgViewBoxZoom&&t.svgWidth===e.svgWidth&&t.svgHeight===e.svgHeight),Vt=(t,e,d,h,r,a)=>{if(!("offsetFrom"in a)||!("offsetTo"in a)||Number.isNaN(a.offsetFrom)||Number.isNaN(a.offsetTo))return;if(a.offsetFrom===a.offsetTo)return Bt(t,e,d,h,r)?{x1:e,y1:d,x2:h,y2:r,offset:a.offsetFrom}:void 0;const[A,g]=[a.offsetFrom,a.offsetTo];for(let c=0;c<Math.PI;c+=Math.PI/8)for(let s=c,o=0;o<2;o++,s+=Math.PI){const[x,i,u,v]=[Math.sin(c)*A,Math.cos(c)*A,Math.sin(s)*g,Math.cos(s)*g];if(Bt(t,e+x,d+i,h+u,r+v))return{x1:e+x,y1:d+i,x2:h+u,y2:r+v,offset:0}}},ve=(t,e,d,h,r,a)=>t===d?{x1:t+5*a,y1:e,x2:d+5*a,y2:h,offset:r}:e===h?{x1:t,y1:e+5*a,x2:d,y2:h+5*a,offset:r}:{x1:t+5*Math.SQRT1_2*a,y1:e+5*Math.SQRT1_2*a,x2:d+5*Math.SQRT1_2*a,y2:h+5*Math.SQRT1_2*a,offset:r},Bt=(t,e,d,h,r)=>!!((e===h||d===r)&&[G.Diagonal,G.Perpendicular].includes(t)||Math.abs((r-d)/(h-e))===1&&[G.Diagonal,G.RotatePerpendicular].includes(t)),Se=(t,e)=>{const d=[],h=[];return Object.values(e).forEach(r=>{var j;if(r.length===1){h.push(...r.map(f=>f.edge));return}const a=t.getEdgeAttribute(r.at(0),"type");if(!r.every(f=>t.getEdgeAttribute(f,"type")===a)){h.push(...r.map(f=>f.edge));return}const A=t.getEdgeAttribute(r.at(0),"style");if(!r.every(f=>t.getEdgeAttribute(f,"style")===A)){h.push(...r.map(f=>f.edge));return}const g={},c=new Set,s=new Set,o=Object.fromEntries(r.map(f=>{var k,T;const[y,l]=t.extremities(f);return g[y]=((k=g[y])!=null?k:0)+1,g[l]=((T=g[l])!=null?T:0)+1,c.add(y),s.add(l),[y,[f.edge,l]]})),x=Array.from(c).filter(f=>g[f]===1),i=Array.from(s).filter(f=>g[f]===1);if(x.length!==1||i.length!==1){h.push(...r.map(f=>f.edge));return}const u=x[0],v=i[0];if(u===v){h.push(...r.map(f=>f.edge));return}const L=[o[u][0]];let M=o[u][1];for(let f=1;f<r.length;f=f+1){const y=(j=o[M])==null?void 0:j.at(1);if(!y){h.push(...r.map(l=>l.edge));return}L.push(o[M][0]),M=y}if(M!==v||L.length!==r.length){h.push(...r.map(f=>f.edge));return}d.push(L)}),{allReconciledLines:d,danglingLines:h}},be=(t,e)=>{if(!e.every(r=>t.hasEdge(r)))return;const d=e.map(r=>{var i,u,v;const[a,A]=t.extremities(r),g=t.getNodeAttributes(a),c=t.getNodeAttributes(A),{type:s}=t.getEdgeAttributes(r),o=(i=t.getEdgeAttribute(r,s))!=null?i:Y[s].defaultAttrs,x=Vt(s,g.x,g.y,c.x,c.y,o);if(x){const{x1:L,y1:M,x2:j,y2:f,offset:y}=x;return Y[G.Simple].generatePath(L,j,M,f,{offset:y})}return(v=(u=Y[s])==null?void 0:u.generatePath(g.x,c.x,g.y,c.y,o))!=null?v:"M ".concat(g.x," ").concat(g.y," L ").concat(c.x," ").concat(c.y)});let h="".concat(d[0]," ");for(let r=1;r<e.length;r=r+1)h+=d[r].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return h},we=t=>[...t.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),Ae=t=>{const e={},d={},h=[],r={},a=[];for(const s of t.edgeEntries()){const[o,x,i,u]=[s.sourceAttributes.x,s.sourceAttributes.y,s.targetAttributes.x,s.targetAttributes.y],v=s.attributes[s.attributes.type],L=Vt(s.attributes.type,o,x,i,u,v);d[s.edge]=L}for(const s of t.edgeEntries()){let o=d[s.edge];const{parallelIndex:x}=s.attributes;if(x>=0){const i=Ft(t,s.attributes.type,s.edge),u=d[i];if(!u){h.push(s);continue}if(x>0){const{x1:v,y1:L,x2:M,y2:j,offset:f}=u;o=ve(v,L,M,j,f,x)}}if(s.attributes.reconcileId!==""){const i=s.attributes.reconcileId;i in r?r[i].push(s):r[i]=[s];continue}if(o){const i=s.edge,u=s.attributes,{x1:v,y1:L,x2:M,y2:j,offset:f}=o;e[i]={attr:u,path:Y[G.Simple].generatePath(v,M,L,j,{offset:f})};continue}a.push(s)}const A=new Set;for(;h.length;){const s=h.pop();if(A.has(s.edge))continue;const{parallel:o}=qt(t,s);if(!o.length)continue;o.forEach(i=>A.add(i.edge));const x=Ut(o);for(const i of o){const u=i.edge;e[u]={attr:i.attributes,path:x[u]}}}const{allReconciledLines:g,danglingLines:c}=Se(t,r);for(const s of g){const o=be(t,s);if(!o)continue;const x=s[0];e[x]={attr:t.getEdgeAttributes(x),path:o}}for(const s of c){const o=t.getEdgeAttributes(s),[x,i]=t.extremities(s),u=t.getNodeAttributes(x),v=t.getNodeAttributes(i);e[s]={attr:o,path:Y[G.Simple].generatePath(u.x,v.x,u.y,v.y,Y[G.Simple].defaultAttrs)}}for(const s of a){const o=s.edge,x=s.attributes.type,i=s.attributes,[u,v,L,M]=[s.sourceAttributes.x,s.sourceAttributes.y,s.targetAttributes.x,s.targetAttributes.y];if(!(x in Y)){e[o]={attr:i,path:"M ".concat(u," ").concat(v," L ").concat(L," ").concat(M)};continue}e[o]={attr:i,path:Y[x].generatePath(u,L,v,M,i[x])}}return Object.entries(e).map(([s,o])=>({id:s,type:"line",line:o}))},ke=t=>{const{activeSnapPoint:e}=t,{svgViewBoxZoom:d}=Z(i=>i.param),h=i=>{const v=[{x:i.x,y:i.y},...i.originalNodesPos].sort((M,j)=>M.x===j.x?M.y-j.y:M.x-j.x),L=(v[1].y-v[0].y)/(v[1].x-v[0].x);if(Math.abs(L)<=.01)return{original:v,offset:v.map(M=>({x:M.x,y:M.y+10})),rotate:0};if(Math.abs(L)>=1e10)return{original:v,offset:v.map(M=>({x:M.x+10,y:M.y})),rotate:90};{const j=-1/L,f=10/Math.sqrt(j*j+1),y=10*j/Math.sqrt(j*j+1);return{original:v,offset:v.map(l=>({x:l.x+f,y:l.y+y})),rotate:-Math.atan(j)*(180/Math.PI)}}},{original:r,offset:a,rotate:A}=h(e),g=i=>{const u=Math.sqrt(3)/2*i,v="0,0",L="".concat(-i/2,",").concat(u),M="".concat(i/2,",").concat(u);return"".concat(v," ").concat(L," ").concat(M)},c=d/75,s=8*c,o="#FC8181",x="".concat(c*5," ").concat(c*2);return m.jsxs(m.Fragment,{children:[m.jsx("line",{x1:a[0].x,y1:a[0].y,x2:a[1].x,y2:a[1].y,stroke:o,strokeWidth:c,strokeDasharray:x}),m.jsx("line",{x1:a[1].x,y1:a[1].y,x2:a[2].x,y2:a[2].y,stroke:o,strokeWidth:c,strokeDasharray:x}),m.jsx("line",{x1:r[0].x,y1:r[0].y,x2:a[0].x,y2:a[0].y,stroke:o,strokeWidth:c,strokeDasharray:x}),m.jsx("line",{x1:r[1].x,y1:r[1].y,x2:a[1].x,y2:a[1].y,stroke:o,strokeWidth:c,strokeDasharray:x}),m.jsx("line",{x1:r[2].x,y1:r[2].y,x2:a[2].x,y2:a[2].y,stroke:o,strokeWidth:c,strokeDasharray:x}),m.jsx("polygon",{points:g(s),transform:"translate(".concat(a[0].x,",").concat(a[0].y,") rotate(").concat((A+270)%360,")"),fill:o}),m.jsx("polygon",{points:g(s),transform:"translate(".concat(a[1].x,",").concat(a[1].y,") rotate(").concat((A+270)%360,")"),fill:o}),m.jsx("polygon",{points:g(s),transform:"translate(".concat(a[1].x,",").concat(a[1].y,") rotate(").concat((A+90)%360,")"),fill:o}),m.jsx("polygon",{points:g(s),transform:"translate(".concat(a[2].x,",").concat(a[2].y,") rotate(").concat((A+90)%360,")"),fill:o})]})},It=t=>{const{id:e,x:d,y:h,handlePointerDown:r,handlePointerMove:a,handlePointerUp:A}=t,g=D.useCallback(o=>r(e,o),[e,r]),c=D.useCallback(o=>a(e,o),[e,a]),s=D.useCallback(o=>A(e,o),[e,A]);return m.jsx("g",{id:e,transform:"translate(".concat(d-6.4," ").concat(h-6.4,")scale(0.025)"),onPointerDown:g,onPointerMove:c,onPointerUp:s,style:{cursor:"move"},children:m.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},Pe=t=>{const{id:e,path:d,handlePointerDown:h}=t,r=D.useCallback(a=>h(e,a),[e,h]);return m.jsx("path",{id:e,d,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:r})},Me=D.memo(t=>{var c,s,o,x,i,u,v,L,M,j,f,y;const{elements:e,handlePointerDown:d,handlePointerMove:h,handlePointerUp:r,handleEdgePointerDown:a}=t,A=Object.fromEntries(Array.from({length:21},(l,k)=>[k-10,{pre:[],main:[],post:[]}]));for(const l of e)if(l.type==="line"){const k=l.line.attr.type,T=l.line.attr.style,$=l.line.attr[T],U=(c=Mt[T])==null?void 0:c.preComponent;U&&A[l.line.attr.zIndex].pre.push(m.jsx(U,{id:l.id,type:k,path:l.line.path,styleAttrs:$,newLine:!1,handlePointerDown:a},"".concat(l.id,".pre")));const I=(o=(s=Mt[T])==null?void 0:s.component)!=null?o:Pe;A[l.line.attr.zIndex].main.push(m.jsx(I,{id:l.id,type:k,path:l.line.path,styleAttrs:$,newLine:!1,handlePointerDown:a},l.id));const Q=(x=Mt[T])==null?void 0:x.postComponent;Q&&A[l.line.attr.zIndex].post.push(m.jsx(Q,{id:l.id,type:k,path:l.line.path,styleAttrs:$,newLine:!1,handlePointerDown:a},"".concat(l.id,".post")))}else if(l.type==="station"){const k=l.station,T=k.type,$=(i=yt[T])==null?void 0:i.preComponent;$&&A[l.station.zIndex].pre.push(m.jsx($,{id:l.id,x:k.x,y:k.y,attrs:k,handlePointerDown:d,handlePointerMove:h,handlePointerUp:r},"".concat(l.id,".pre")));const U=(v=(u=yt[T])==null?void 0:u.component)!=null?v:It;A[l.station.zIndex].main.push(m.jsx(U,{id:l.id,x:k.x,y:k.y,attrs:k,handlePointerDown:d,handlePointerMove:h,handlePointerUp:r},l.id));const I=(L=yt[T])==null?void 0:L.postComponent;I&&A[l.station.zIndex].post.push(m.jsx(I,{id:l.id,x:k.x,y:k.y,attrs:k,handlePointerDown:d,handlePointerMove:h,handlePointerUp:r},"".concat(l.id,".post")))}else if(l.type==="misc-node"){const k=l.miscNode,T=k.type,$=(M=gt[T])==null?void 0:M.preComponent;$&&A[l.miscNode.zIndex].pre.push(m.jsx($,{id:l.id,x:k.x,y:k.y,attrs:k[T],handlePointerDown:d,handlePointerMove:h,handlePointerUp:r},"".concat(l.id,".pre")));const U=(f=(j=gt[T])==null?void 0:j.component)!=null?f:It;A[l.miscNode.zIndex].main.push(m.jsx(U,{id:l.id,x:k.x,y:k.y,attrs:k[T],handlePointerDown:d,handlePointerMove:h,handlePointerUp:r},l.id));const I=(y=gt[T])==null?void 0:y.postComponent;I&&A[l.miscNode.zIndex].post.push(m.jsx(I,{id:l.id,x:k.x,y:k.y,attrs:k[T],handlePointerDown:d,handlePointerMove:h,handlePointerUp:r},"".concat(l.id,".post")))}return Array.from({length:21},(l,k)=>(k-10).toString()).map(l=>[...A[l].pre,...A[l].main,...A[l].post]).flat()},(t,e)=>t.elements===e.elements),Ce=[...Object.values(Qt),nt.Virtual,nt.Master,nt.LondonArrow,nt.ChongqingRTNumLineBadge2021,nt.ChongqingRTTextLineBadge2021,nt.ChengduRTLineBadge,nt.GzmtrLineBadge],je=()=>{const t=Ht(),e=D.useRef(window.graph),d=()=>{t(vt(e.current.export())),t(dt()),t(ut())},{telemetry:{project:h},preference:{autoParallel:r,gridLines:a,snapLines:A}}=Z(P=>P.app),{svgViewBoxZoom:g,svgViewBoxMin:c}=Z(P=>P.param),{selected:s,refresh:{nodes:o,edges:x},mode:i,active:u,keepLastPath:v,theme:L}=Z(P=>P.runtime),M=Xt(),{height:j,width:f}=Kt(M),[y,l]=D.useState(),[k,T]=D.useState({dx:0,dy:0}),[$,U]=D.useState([]),[I,Q]=D.useState([]),[ot,it]=D.useState([]);D.useEffect(()=>{if(!y||!A)return;const P=Lt(c,g,f,j),N=Yt(e.current,...Object.values(P));Q(N),U(ie(e.current,N))},[c,g,f,j,y]);const[rt,at]=D.useState(void 0),bt=q((P,N)=>{N.stopPropagation(),i==="select"&&t(tt("free"));const K=N.currentTarget,{x:R,y:W}=et(N);K.setPointerCapture(N.pointerId),it([]),at(void 0),l({x:R,y:W}),t(ft(P)),N.shiftKey?s.has(P)?t(_t(P)):t(Et(P)):s.has(P)||t(lt(new Set([P])))}),wt=q((P,N)=>{const{x:K,y:R}=et(N);if(i==="free"&&u===P){if(!N.altKey&&A){const W=e.current.getNodeAttribute(P,"x"),V=e.current.getNodeAttribute(P,"y"),n=W-(y.x-K)*g/100,p=V-(y.y-R)*g/100;let b=n,E=p;if(re(P,e.current)){let S=ot,C=rt;if(S.length!==0&&(S=S.filter(w=>ae(w,n,p)<=6)),C&&(S.length===0||Math.hypot(n-C.x,p-C.y)>6)&&(C=void 0),!C&&S.length===1){const w=S[0],{snapPoint:B,distance:H}=ce(e.current,I.filter(O=>!s.has(O)),n,p,w);H<=3&&(C=B)}if(S.length===1&&!C||S.length===0){const{l:w,d:B}=le(n,p,$,I.filter(O=>!s.has(O)&&!S.some(F=>F.node===O))),H=S.length===0||!S.some(O=>O.a===w.a&&O.b===w.b);B<3&&S.length<2&&H&&S.push(w)}if(S.length===1)if(C)b=C.x,E=C.y;else{const w=S[0];if(w.a==0)E=-w.c/w.b;else if(w.b==0)b=-w.c/w.a;else{const B=-w.a/w.b,H=-w.c/w.b;E=B*b+H}}else if(S.length===2){const w=S[0],B=S[1],H=w.a*B.b-B.a*w.b;H!==0&&(b=-(w.c*B.b-B.c*w.b)/H,E=-(w.a*B.c-B.a*w.c)/H)}it(S),at(C)}const z=b-W,_=E-V;s.forEach(S=>{e.current.hasNode(S)&&e.current.updateNodeAttributes(S,C=>({...C,x:X(C.x+z,.01),y:X(C.y+_,.01)}))})}else it([]),at(void 0),s.forEach(W=>{e.current.hasNode(W)&&e.current.updateNodeAttributes(W,V=>({...V,x:X(V.x-(y.x-K)*g/100,N.altKey?.01:5),y:X(V.y-(y.y-R)*g/100,N.altKey?.01:5)}))});t(dt()),t(ut())}else i.startsWith("line")&&T({dx:(y.x-K)*g/100,dy:(y.y-R)*g/100})}),At=q((P,N)=>{if(i.startsWith("line")){v||t(tt("free"));const K=e.current.hasNode(u)&&Ce.includes(e.current.getNodeAttribute(u,"type"));["stn_core_","virtual_circle_","misc_node_connectable_"].forEach(W=>{var b,E;const n=(E=(b=document.elementsFromPoint(N.clientX,N.clientY)[0].attributes)==null?void 0:b.getNamedItem("id"))==null?void 0:E.value,p=n==null?void 0:n.startsWith(W);if(K&&p){const z=i.slice(5),_="line_".concat(ht(10)),[S,C]=[u,n.slice(W.length)],w=r?Gt(e.current,z,S,C,"from"):-1;e.current.addDirectedEdgeWithKey(_,S,C,{visible:!0,zIndex:0,type:z,[z]:structuredClone(Y[z].defaultAttrs),style:$t.SingleColor,[$t.SingleColor]:{color:L},reconcileId:"",parallelIndex:w}),t(lt(new Set([_]))),h&&xt.event(mt.ADD_LINE,{type:z})}}),t(vt(e.current.export())),t(ut())}else if(i==="free"&&u){const{x:K,y:R}=et(N);y.x-K===0&&y.y-R===0||(t(vt(e.current.export())),t(dt()))}it([]),at(void 0),l(void 0),t(ft(void 0))}),kt=q((P,N)=>{if(N.stopPropagation(),N.shiftKey||t(St()),N.shiftKey&&s.has(P)?t(_t(P)):t(Et(P)),i.startsWith("station")||i.startsWith("misc-node-virtual")||i.startsWith("misc-node-master")){const K=N.clientX-document.getElementById("canvas").getBoundingClientRect().left,R=N.clientY-document.getElementById("canvas").getBoundingClientRect().top,W=i.startsWith("station"),V=ht(10),n=W?"stn_".concat(V):"misc_node_".concat(V),p=W?i.slice(8):i.slice(10),{x:b,y:E}=J(K,R,g,c),z=W?structuredClone(yt[p].defaultAttrs):structuredClone(gt[p].defaultAttrs);"color"in z&&(z.color=L),e.current.addNode(n,{visible:!0,zIndex:0,x:X(b,5),y:X(E,5),type:p,[p]:z});const _=e.current.getEdgeAttributes(P),{zIndex:S,type:C,style:w}=_,B=_[C],H=_[w],[O,F]=e.current.extremities(P),zt=r?0:-1;e.current.addDirectedEdgeWithKey("line_".concat(ht(10)),O,n,{visible:!0,zIndex:S,type:C,[C]:structuredClone(B),style:w,[w]:structuredClone(H),reconcileId:"",parallelIndex:zt}),e.current.addDirectedEdgeWithKey("line_".concat(ht(10)),n,F,{visible:!0,zIndex:S,type:C,[C]:structuredClone(B),style:w,[w]:structuredClone(H),reconcileId:"",parallelIndex:zt}),e.current.dropEdge(P),d(),h&&(xt.event(mt.ADD_STATION,{type:p}),xt.event(mt.ADD_LINE,{type:C})),t(tt("free")),t(lt(new Set([n])))}}),Pt=D.useMemo(()=>[...Ae(e.current),...we(e.current)],[x,o]),ct=Zt.component;return m.jsxs(m.Fragment,{children:[m.jsx(Me,{elements:Pt,handlePointerDown:bt,handlePointerMove:wt,handlePointerUp:At,handleEdgePointerDown:kt}),i.startsWith("line")&&u&&u!=="background"&&m.jsx(ct,{id:"line_create_in_progress___no_use",type:i.slice(5),path:Y[i.slice(5)].generatePath(e.current.getNodeAttribute(u,"x"),e.current.getNodeAttribute(u,"x")-k.dx,e.current.getNodeAttribute(u,"y"),e.current.getNodeAttribute(u,"y")-k.dy,Y[i.slice(5)].defaultAttrs),styleAttrs:{color:L},newLine:!0,handlePointerDown:()=>{}}),ot.length!==0&&ot.map(P=>m.jsx("path",{d:Y[G.Simple].generatePath(...de(P,Lt(c,g,f,j)),Y[G.Simple].defaultAttrs),stroke:"cyan",strokeWidth:g/75},"snap_line_".concat(P.a,"_").concat(P.b,"_").concat(P.c,"_").concat(P.node))),rt&&m.jsx(ke,{activeSnapPoint:rt})]})},Te=()=>{const t=Ht(),e=D.useRef(window.graph),d=()=>{t(vt(e.current.export())),t(dt()),t(ut())},{activeSubscriptions:h}=Z(n=>n.account),{telemetry:{project:r},preference:{randomStationsNames:a,gridLines:A,snapLines:g}}=Z(n=>n.app),{svgViewBoxZoom:c,svgViewBoxMin:s}=Z(n=>n.param),{mode:o,lastTool:x,active:i,selected:u,keepLastPath:v,theme:L,count:{masters:M,lines:j}}=Z(n=>n.runtime),f=Xt(),{height:y,width:l}=Kt(f),k=!1,T=!1;Jt();const[$,U]=D.useState({x:0,y:0}),[I,Q]=D.useState({x:0,y:0}),[ot,it]=D.useState({x:0,y:0}),[rt,at]=D.useState({x:0,y:0}),bt=q(async n=>{const{x:p,y:b}=et(n);if(o.startsWith("station")||o.startsWith("misc-node")){t(tt("free"));const E=ht(10),{x:z,y:_}=J(p,b,c,s),S=o.startsWith("station"),C=S?"stn_".concat(E):"misc_node_".concat(E),w=S?o.slice(8):o.slice(10),B=structuredClone({...yt,...gt}[w].defaultAttrs);if(se.has(w)&&(B.color=L),S){const H=B.names,O=await t(Tt(jt.Shmetro));if(Tt.fulfilled.match(O)){const F=O.payload;H.length>F.length?F.push(...Array(H.length-F.length).fill(F.at(-1))):H.length<F.length&&F.splice(H.length,F.length-H.length),B.names=F}}e.current.addNode(C,{visible:!0,zIndex:0,x:X(z,5),y:X(_,5),type:w,[w]:B}),d(),r&&xt.event(mt.ADD_STATION,{type:w}),t(lt(new Set([C])))}else o==="free"||o.startsWith("line")?(o.startsWith("line")&&(t(tt("free")),v&&t(oe(!1))),it({x:p,y:b}),at(s),n.shiftKey||(t(ft("background")),t(St()))):o==="select"&&(U(J(p,b,c,s)),Q(J(p,b,c,s)))}),wt=q(n=>{if(o==="select"){if($.x!=0&&$.y!=0){const{x:p,y:b}=et(n);Q(J(p,b,c,s))}}else if(i==="background"){const{x:p,y:b}=et(n);t(pt({x:rt.x+(ot.x-p)*c/100,y:rt.y+(ot.y-b)*c/100}))}}),At=q(n=>{if(o==="select"){const{x:p,y:b}=et(n),{x:E,y:z}=J(p,b,c,s),_=Yt(e.current,$.x,$.y,E,z),S=he(e.current,new Set(_));t(lt(new Set([...n.shiftKey?u:[],..._,...S]))),t(tt("free")),U({x:0,y:0}),Q({x:0,y:0})}i==="background"&&!n.shiftKey&&t(ft(void 0))}),kt=q(n=>{let p=c;n.deltaY>0&&c+10<400?p=c+10:n.deltaY<0&&c-10>0&&(p=c-10),t(Nt(p));const{x:b,y:E}=et(n),z=n.currentTarget.getBoundingClientRect(),[_,S]=[b/z.width,E/z.height];t(pt({x:s.x+b*c/100-l*p/100*_,y:s.y+E*c/100-y*p/100*S}))}),Pt=q(async n=>{if(st?n.key==="Backspace":n.key==="Delete")u.size>0&&(u.forEach(p=>{e.current.hasNode(p)?e.current.dropNode(p):e.current.hasEdge(p)&&e.current.dropEdge(p)}),t(St()),d());else if(n.key.startsWith("Arrow")){const b=n.key.endsWith("Left")?-1:n.key.endsWith("Right")?1:0,E=n.key.endsWith("Up")?-1:n.key.endsWith("Down")?1:0;t(pt(J(100*b,100*E,c,s)))}else if(n.key==="i"||n.key==="j"||n.key==="k"||n.key==="l"){const b=(n.key==="j"?-1:n.key==="l"?1:0)*10,E=(n.key==="i"?-1:n.key==="k"?1:0)*10;u.size>0&&u.forEach(z=>{e.current.hasNode(z)&&(e.current.updateNodeAttribute(z,"x",_=>(_!=null?_:0)+b),e.current.updateNodeAttribute(z,"y",_=>(_!=null?_:0)+E),d())})}else if(n.key==="f"&&x)t(tt(x));else if(n.key==="z"&&(st?n.metaKey&&!n.shiftKey:n.ctrlKey))st&&n.preventDefault(),t(te()),t(dt()),t(ut());else if(n.key==="s")t(tt("select"));else if((n.key==="c"||n.key==="x")&&(st?n.metaKey&&!n.shiftKey:n.ctrlKey)){const p=fe(e.current,u);navigator.clipboard.writeText(p),n.key==="x"&&(t(St()),u.forEach(b=>{e.current.hasNode(b)?e.current.dropNode(b):e.current.hasEdge(b)&&e.current.dropEdge(b)}),d())}else if(n.key==="v"&&(st?n.metaKey&&!n.shiftKey:n.ctrlKey)){const p=await navigator.clipboard.readText(),{x:b,y:E}=J(l/2,y/2,c,s),{nodes:z,edges:_}=ye(p,e.current,k,T,X(b,5),X(E,5));d();const S=structuredClone(z);_.forEach(C=>S.add(C)),t(lt(S))}else st&&n.key==="z"&&n.metaKey&&n.shiftKey||!st&&n.key==="y"&&n.ctrlKey?(t(ee()),t(dt()),t(ut())):n.key==="c"&&t(ne(!g))}),[ct,P]=D.useState(0),N=q(n=>{if(n.touches.length===2){t(ft(void 0));const[p,b]=[n.touches[0].clientX-n.touches[1].clientX,n.touches[0].clientY-n.touches[1].clientY];P(p*p+b*b)}}),K=q(n=>{if(ct!==0&&n.touches.length===2){const[p,b]=[n.touches[0].clientX-n.touches[1].clientX,n.touches[0].clientY-n.touches[1].clientY],E=p*p+b*b;let z=c;E-ct<0&&c+10<=390?z=c+10:E-ct>0&&c-10>=10&&(z=c-10),t(Nt(z)),P(E);const _=n.currentTarget.getBoundingClientRect(),[S,C]=[(n.touches[0].clientX+n.touches[1].clientX)/2-_.left,(n.touches[0].clientY+n.touches[1].clientY)/2-_.top],[w,B]=[S/_.width,C/_.height];t(pt({x:s.x+S*c/100-l*z/100*w,y:s.y+C*c/100-y*z/100*B}))}}),R=q(n=>{ct!==0&&P(0)}),[W,V]=D.useState({sx:0,sy:0,ex:0,ey:0});return D.useEffect(()=>{V({sx:$.x<=I.x?$.x:I.x,ex:$.x>I.x?$.x:I.x,sy:$.y<=I.y?$.y:I.y,ey:$.y>I.y?$.y:I.y})},[I.x,I.y]),m.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:y,width:l,viewBox:"".concat(s.x," ").concat(s.y," ").concat(l*c/100," ").concat(y*c/100),onPointerDown:bt,onPointerMove:wt,onPointerUp:At,onTouchStart:N,onTouchMove:K,onTouchEnd:R,onWheel:kt,tabIndex:0,onKeyDown:Pt,children:[A&&m.jsx(me,{svgViewBoxMin:s,svgViewBoxZoom:c,svgWidth:l,svgHeight:y}),m.jsx(ue.SvgAssetsContextProvider,{children:m.jsx(je,{})}),o==="select"&&$.x!=0&&$.y!=0&&m.jsx("rect",{x:W.sx,y:W.sy,width:W.ex-W.sx,height:W.ey-W.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),m.jsx("defs",{children:m.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[m.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),m.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})})]})};export{Te as default};
